{% extends 'dashboard/index.html' %}
{% load static %}
{% block head %}
<link rel="stylesheet" href="{% static 'icons/bootstrap-icons.css' %}" />
<link rel="stylesheet" href="{% static 'css/daterangepicker.css' %}"/>
{% endblock head %}
{% block menusidebar %}
<li class="nav-item">
  <a
    href="{% url 'dshbindex' %}"
    class="nav-link text-white"
    aria-current="page"
  >
    <i class="bi bi-speedometer me-3"></i>
    <span class="align-middle">Dashboard</span>
  </a>
</li>
<li>
  <a href="{% url 'listrifas' %}" class="nav-link text-white active">
    <i class="bi bi-8-circle-fill me-3"></i>
    <span class="align-middle">Rifas</span>
  </a>
</li>
<li>
  <a href="#" class="nav-link text-white">
    <i class="bi bi-ui-checks-grid me-3"></i>
    <span class="align-middle">Productos</span>
  </a>
</li>
<li>
  <a href="#" class="nav-link text-white">
    <i class="bi bi-cash-coin me-3"></i>
    <span class="align-middle">Pagos</span>
  </a>
</li>
{% endblock menusidebar %} 
{% block contentright %}
<div class="col-12">
    <h5 class="mt-3">Nueva Rifa</h5>
    <div class="row">
        <form id="rifaForm" method="post" action="{% url 'saverifa' %}" enctype=multipart/form-data>
            {% csrf_token %}
            <div class="row">
                <div class="mb-3 col-lg-6 col-md-12">
                    <label for="inputFile" class="form-label">Imagen</label>
                    <input type="file" name="imagen" class="form-control" id="inputFile">
                </div>
                <div class="mb-3 col-lg-6 col-md-12">
                    <label for="dateRangePicker" class="form-label">Rango de Fecha</label>
                    <input type="text" class="form-control" name="daterange" value="" />
                </div>
                <div class="mb-3 col-lg-6 col-md-12">
                    <label for="exampleFormControlTextarea1" class="form-label">Descripcción</label>
                    <textarea class="form-control" name="descripccion" id="exampleFormControlTextarea1" rows="3"></textarea>
                </div>
                <div class="collapse" id="collapseProgressBar">
                    <div class="card card-body">
                        <h6>Generando boletos...</h6>
                        <div class="progress">
                            <div id="progress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
                          </div>                                                    
                    </div>
                    <div class="card-footer bg-warning">
                        <h7 class="text-dark">No reinicie ni actualice su navegador mientras se completa esta acción.</h7>
                    </div>
                  </div>
                
            </div>
              <button id="btnGuardar" class="mt-3 btn btn-success" type="submit"><i class="bi bi-save2-fill"></i> Guardar</button>
        </form>
        
    </div>
</div>
{% endblock contentright %}
{% block script %}
<script src="{% static 'js/moment.min.js' %}"></script>
<script src="{% static 'js/daterangepicker.min.js' %}"></script>
<script type="text/javascript">
    $(document).ready(function(){
        $("#rifaForm").submit(function (e) {
            $('#collapseProgressBar').collapse('show');
            $('#btnGuardar').attr("disabled", "");
            e.preventDefault();
            var formId = this.id;
            const form = $("#rifaForm");
            var data = new FormData(form[0]);
            var urlAdd = $("#rifaForm").attr('action');
            $.ajax({
                url: urlAdd,
                type: "POST",
                data: data,
                processData: false,
                contentType: false,
                dataType: "json",
                success: function(data, textStatus, jqXHR){

                            {% comment %} $('#collapse-form').collapse('hide');
                            console.log(data.cuota);
                            let cuota = Math.round(parseFloat(data.cuota)/1024);
                            console.log(data.consumo);
                            let consumo = Math.round(parseFloat(data.consumo)/1024);
                            document.getElementById('username').innerHTML = data.username;
                            document.cookie = "username="+data.id+";SameSite=Lax";
                            document.getElementById('cuota-maxima').innerHTML = cuota;
                            document.getElementById('cuota-consumida').innerHTML = consumo;
                            let porciento = Math.round((consumo * 100) / cuota);
                            let progressbar = document.getElementById('progress');
                            if(porciento > 100){
                                progressbar.setAttribute("data-percent", "100");
                                $(".progress-bar1").loading();
                            }else{
                                progressbar.setAttribute("data-percent",porciento);
                                $(".progress-bar1").loading();
                            }
                            $('#collapse-progressbar').collapse('show'); {% endcomment %}


                        },
                error: function(jqXHR, textStatus, errorThrown){
                            {% comment %} document.getElementById('error').innerHTML = jqXHR.responseJSON.message;
                            $('#error').collapse('show');
                            setTimeout(function () {
                                $('#error').collapse('hide');
                            }, 3000); {% endcomment %}




                        }
                    });
        });
    });
    
    $(function() {    
      $('input[name="daterange"]').daterangepicker({
          autoUpdateInput: false,
          locale: {
              cancelLabel: 'Clear'
          }
      });
    
      $('input[name="daterange"]').on('apply.daterangepicker', function(ev, picker) {
          $(this).val(picker.startDate.format('YYYY-MM-DD') + ' - ' + picker.endDate.format('YYYY-MM-DD'));
      });
    
      $('input[name="daterange"]').on('cancel.daterangepicker', function(ev, picker) {
          $(this).val('');
      });
    
    });
    </script>
<script>
    var socket = new WebSocket('ws://sock.onat.gob.cu/ws');
    socket.onmessage = function(event){
        var data = JSON.parse(event.data);
        if (data.message == 'Generando...'){
            var porciento = (parseInt(data.status, 10)*100)/ parseInt(data.end, 10);
            $("#progress").css("width",porciento+"%");
            if(porciento == 100){
                $(location).attr("href","{% url 'listrifas' %}");
            }
        }
        
    }
</script>

{% endblock script %}



